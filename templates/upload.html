<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kiss-drop</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>kiss-drop</h1>

        <div id="upload-area" class="upload-area">
            <p>Drop file here or click to select</p>
            <input type="file" id="file-input" hidden>
        </div>

        <div id="file-info" class="file-info" hidden>
            <span id="file-name"></span>
            <span id="file-size"></span>
        </div>

        <div class="options">
            <label>
                Expires in:
                <select id="expires-in">
                    <option value="1">1 day</option>
                    <option value="7">7 days</option>
                    <option value="default" selected>30 days (default)</option>
                    <option value="90">90 days</option>
                    <option value="never">Never</option>
                </select>
            </label>
            <label>
                Password (optional):
                <input type="password" id="password" placeholder="Leave empty for no password">
            </label>
        </div>

        <button id="upload-btn" class="btn" disabled>Upload</button>

        <div id="progress" class="progress" hidden>
            <div id="progress-bar" class="progress-bar"></div>
        </div>

        <div id="result" class="result" hidden>
            <p>Share link:</p>
            <div class="link-box">
                <input type="text" id="share-link" readonly>
                <button id="copy-btn" class="btn btn-small">Copy</button>
            </div>
        </div>

        <div id="error" class="error" hidden></div>
    </div>

    <script src="/static/upload.js"></script>
    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const uploadBtn = document.getElementById('upload-btn');
        const progress = document.getElementById('progress');
        const progressBar = document.getElementById('progress-bar');
        const result = document.getElementById('result');
        const shareLink = document.getElementById('share-link');
        const copyBtn = document.getElementById('copy-btn');
        const errorDiv = document.getElementById('error');
        const passwordInput = document.getElementById('password');
        const expiresIn = document.getElementById('expires-in');

        let selectedFile = null;

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }

        function selectFile(file) {
            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatSize(file.size);
            fileInfo.hidden = false;
            uploadBtn.disabled = false;
            result.hidden = true;
            errorDiv.hidden = true;
        }

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                selectFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                selectFile(fileInput.files[0]);
            }
        });

        function uploadSimple() {
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('expires_in', expiresIn.value);
            if (passwordInput.value) {
                formData.append('password', passwordInput.value);
            }

            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressBar.style.width = percent + '%';
                }
            });

            xhr.addEventListener('load', () => {
                progress.hidden = true;
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    shareLink.value = data.url;
                    result.hidden = false;
                } else {
                    errorDiv.textContent = 'Upload failed: ' + xhr.responseText;
                    errorDiv.hidden = false;
                    uploadBtn.disabled = false;
                }
            });

            xhr.addEventListener('error', () => {
                progress.hidden = true;
                errorDiv.textContent = 'Upload failed: Network error';
                errorDiv.hidden = false;
                uploadBtn.disabled = false;
            });

            xhr.open('POST', '/api/upload');
            xhr.send(formData);
        }

        function uploadChunked() {
            const uploader = new ChunkedUploader(selectedFile, {
                password: passwordInput.value,
                expiresIn: expiresIn.value,
                onProgress: (percent) => {
                    progressBar.style.width = percent + '%';
                },
                onComplete: (data) => {
                    progress.hidden = true;
                    shareLink.value = data.url;
                    result.hidden = false;
                },
                onError: (error) => {
                    progress.hidden = true;
                    errorDiv.textContent = 'Upload failed: ' + error.message;
                    errorDiv.hidden = false;
                    uploadBtn.disabled = false;
                }
            });

            uploader.start();
        }

        uploadBtn.addEventListener('click', () => {
            if (!selectedFile) return;

            uploadBtn.disabled = true;
            progress.hidden = false;
            progressBar.style.width = '0%';
            result.hidden = true;
            errorDiv.hidden = true;

            // Use chunked upload for large files
            if (shouldUseChunkedUpload(selectedFile)) {
                uploadChunked();
            } else {
                uploadSimple();
            }
        });

        copyBtn.addEventListener('click', () => {
            shareLink.select();
            document.execCommand('copy');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy', 2000);
        });
    </script>
</body>
</html>
